<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <title>Example</title>
</head>

<body>
  <div class="container my-5">
    <div class="row">
      <div class="col-8">
        <p class="border" id="messageOutput" style="height: 100%;">
          Mesaj kısmı
        </p>
        <table id="rooms-list" style="width: 100%;"></table>
        <div class="input-group input-group-sm mb-3">
          <input type="text" id="messageInput" class="form-control" aria-label="Small"
            aria-describedby="inputGroup-sizing-sm">
          <div class="input-group-prepend">
            <button class="btn bg-primary" onclick='sendMessage()'> Gönder </button>
          </div>
        </div>
      </div>
      <div class="col-4" id="videos-container">
        
        <button class="btn bg-success col-4" id="connect"> Baglan </button>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
    integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"></script>
  <script src="PeerConnection.js"></script>

</body>
<script>
  /*
    Klasik Websocket Ayarları

    --------------------------------------------------------------------------------
  */

  var websocket = new WebSocket('ws://localhost:8080/socket');

  websocket.onerror = function () {
    console.log("Websocket Error!")
  };

  websocket.onclose = function () {
    console.log("Websocket Closed!")
  };

  websocket.push = websocket.send;
  websocket.send = function (data) {
    websocket.push(JSON.stringify(data));
  };

  /* -------------------------------------------------------------------------------- */

  /*
          PeerConnection 
    
    ---------------------------------------------------------------------------------
  */
  var peer = new PeerConnection(websocket);
  var myVideo = document.getElementById("myVideo");
  var yourVideo = document.getElementById("yourVideo");  


  peer.onUserFound = function (userid) {
    if (document.getElementById(userid)) return;
    var tr = document.createElement('tr');

    var td1 = document.createElement('td');
    var td2 = document.createElement('td');

    td1.innerHTML = userid + ' has camera. Are you interested in video chat?';

    var button = document.createElement('button');
    button.innerHTML = 'Join';
    button.id = userid;
    button.style.float = 'right';
    button.onclick = function () {
      button = this;
      getUserMedia(function (stream) {
        peer.addStream(stream);
        peer.sendParticipationRequest(button.id);
      });
      button.disabled = true;
    };
    td2.appendChild(button);

    tr.appendChild(td1);
    tr.appendChild(td2);
    roomsList.appendChild(tr);
  };

  peer.onStreamAdded = function (e) {
    if (e.type == 'local') document.querySelector('#connect').disabled = false;
    var video = e.mediaElement;

    video.setAttribute('width', 600);
    video.setAttribute('controls', true);

    videosContainer.insertBefore(video, videosContainer.firstChild);

    video.play();
    rotateVideo(video);
    scaleVideos();
  };

  peer.onStreamEnded = function (e) {
    var video = e.mediaElement;
    if (video) {
      video.style.opacity = 0;
      rotateVideo(video);
      setTimeout(function () {
        video.parentNode.removeChild(video);
        scaleVideos();
      }, 1000);
    }
  };

  document.querySelector('#connect').onclick = function () {
    this.disabled = true;
    getUserMedia(function (stream) {
      peer.addStream(stream);
      peer.startBroadcasting();
    });
  };
  /*
  document.querySelector('#your-name').onchange = function () {
    peer.userid = this.value;
  };
  */
  var videosContainer = document.getElementById('videos-container') || document.body;
  var btnSetupNewRoom = document.getElementById('setup-new-room');
  var roomsList = document.getElementById('rooms-list');

  if (btnSetupNewRoom) btnSetupNewRoom.onclick = setupNewRoomButtonClickHandler;

  function rotateVideo(video) {
    video.style[navigator.mozGetUserMedia ? 'transform' : '-webkit-transform'] = 'rotate(0deg)';
    setTimeout(function () {
      video.style[navigator.mozGetUserMedia ? 'transform' : '-webkit-transform'] = 'rotate(360deg)';
    }, 1000);
  }

  function scaleVideos() {
    var videos = document.querySelectorAll('video'),
      length = videos.length,
      video;

    var minus = 130;
    var windowHeight = 700;
    var windowWidth = 600;
    var windowAspectRatio = windowWidth / windowHeight;
    var videoAspectRatio = 4 / 3;
    var blockAspectRatio;
    var tempVideoWidth = 0;
    var maxVideoWidth = 0;

    for (var i = length; i > 0; i--) {
      blockAspectRatio = i * videoAspectRatio / Math.ceil(length / i);
      if (blockAspectRatio <= windowAspectRatio) {
        tempVideoWidth = videoAspectRatio * windowHeight / Math.ceil(length / i);
      } else {
        tempVideoWidth = windowWidth / i;
      }
      if (tempVideoWidth > maxVideoWidth)
        maxVideoWidth = tempVideoWidth;
    }
    for (var i = 0; i < length; i++) {
      video = videos[i];
      if (video)
        video.width = maxVideoWidth - minus;
    }
  }

  window.onresize = scaleVideos;

  // you need to capture getUserMedia yourself!
  function getUserMedia(callback) {
    var hints = {
      audio: true,
      video: {
        optional: [],
        mandatory: {}
      }
    };
    navigator.getUserMedia(hints, function (stream) {
      var video = document.createElement('video');
      video.srcObject = stream;
      video.controls = true;
      video.muted = true;

      peer.onStreamAdded({
        mediaElement: video,
        userid: 'self',
        stream: stream
      });

      callback(stream);
    });
  }

  
</script>

</html>